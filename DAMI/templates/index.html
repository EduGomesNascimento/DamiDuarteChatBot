{% extends "layout.html" %}

{% block content %}
<section class="grid">
  <div class="card moon-card">
    <div class="moon-card__header">
      <h2>Fase da Lua</h2>
      <span id="moon-date"></span>
    </div>
    <div class="moon-card__body">
      <div class="moon-visual" id="moon-visual"></div>
      <div class="moon-info">
        <h3 id="moon-phase">Carregando...</h3>
        <p id="moon-illumination"></p>
      </div>
    </div>
    <div class="moon-card__footer">
      <p>Use esta energia para cuidar das suas clientes ✨</p>
    </div>
  </div>

  <div class="card actions-card">
    <h2>Campanha em Massa</h2>
    <form method="post" action="{{ url_for('send_campaign') }}">
      <label>Mensagem promocional</label>
      <textarea name="message" rows="4" placeholder="Escreva sua mensagem..." required></textarea>
      <label>Imagem opcional (caminho local)</label>
      <input type="text" name="image_path" placeholder="C:\\caminho\\para\\imagem.jpg" />
      <button type="submit" class="primary">Enviar para todas</button>
      <p class="hint">
        O sistema aplica delays aleatórios (10-30s) para evitar bloqueios do WhatsApp.
      </p>
    </form>
  </div>
</section>

<section class="grid">
  <div class="card">
    <div class="card-header">
      <h2>Ações Automáticas</h2>
      <form method="post" action="{{ url_for('run_scheduler_now') }}">
        <button type="submit" class="ghost">Rodar agora</button>
      </form>
    </div>
    <form id="tasks-bulk" method="post" action="{{ url_for('bulk_done_tasks') }}"></form>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" data-select-all="task_ids" /></th>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Agendamento</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for task in tasks %}
          <tr class="status-{{ task.status }}">
            <td>
              <input type="checkbox" name="task_ids" value="{{ task.id }}" form="tasks-bulk" />
            </td>
            <td>
              <strong>{{ task.name }}</strong>
              <small>{{ task.phone }}</small>
            </td>
            <td>{{ task.task_type }}</td>
            <td>{{ task.status }}</td>
            <td>{{ task.scheduled_for }}</td>
            <td>
              <form method="post" action="{{ url_for('toggle_task', task_id=task.id) }}">
                <button type="submit" class="ghost">Toggle</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6">Nenhuma ação automática registrada.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="button-row">
      <button type="submit" class="primary" form="tasks-bulk">Marcar como feito</button>
      <button type="submit" class="ghost" form="tasks-bulk" formaction="{{ url_for('bulk_delete_tasks') }}">
        Apagar selecionadas
      </button>
    </div>
  </div>

  <div class="card">
    <h2>Cadastro de Cliente</h2>
    <form method="post" action="{{ url_for('create_client') }}" class="form-grid">
      <input type="text" name="name" placeholder="Nome completo" required />
      <input type="text" name="phone" placeholder="WhatsApp +55..." required />
      <input type="date" name="birth_date" />
      <input type="date" name="last_appointment" />
      <input type="date" name="last_contacted" />
      <button type="submit" class="primary">Salvar cliente</button>
    </form>
  </div>
</section>

<section class="card">
  <div class="card-header">
    <h2>Clientes</h2>
  </div>
  <form id="clients-bulk" method="post" action="{{ url_for('bulk_delete_clients') }}"></form>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" data-select-all="client_ids" /></th>
          <th>Nome</th>
          <th>WhatsApp</th>
          <th>Aniversário</th>
          <th>Último agendamento</th>
          <th>Último contato</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for client in clients %}
        <tr>
          <td>
            <input type="checkbox" name="client_ids" value="{{ client.id }}" form="clients-bulk" />
          </td>
          <td>{{ client.name }}</td>
          <td>{{ client.phone }}</td>
          <td>{{ client.birth_date or "-" }}</td>
          <td>{{ client.last_appointment or "-" }}</td>
          <td>{{ client.last_contacted or "-" }}</td>
          <td>
            <details>
              <summary class="ghost">Editar</summary>
              <form method="post" action="{{ url_for('edit_client', client_id=client.id) }}" class="edit-form">
                <input type="text" name="name" value="{{ client.name }}" required />
                <input type="text" name="phone" value="{{ client.phone }}" required />
                <input type="date" name="birth_date" value="{{ client.birth_date }}" />
                <input type="date" name="last_appointment" value="{{ client.last_appointment }}" />
                <input type="date" name="last_contacted" value="{{ client.last_contacted }}" />
                <button type="submit" class="primary">Atualizar</button>
              </form>
              <form method="post" action="{{ url_for('delete_client', client_id=client.id) }}">
                <button type="submit" class="ghost danger">Excluir</button>
              </form>
            </details>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7">Nenhuma cliente cadastrada ainda.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="button-row">
    <button type="submit" class="ghost danger" form="clients-bulk">Apagar selecionadas</button>
  </div>
</section>

<section class="card">
  <h2>Últimos envios</h2>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Quando</th>
          <th>Cliente</th>
          <th>Tipo</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for log in logs %}
        <tr>
          <td>{{ log.created_at }}</td>
          <td>{{ log.name or log.phone }}</td>
          <td>{{ log.message_type }}</td>
          <td>{{ log.status }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4">Nenhum envio registrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
